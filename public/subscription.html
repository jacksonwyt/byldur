<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Subscription - Byldur</title>
  <link rel="stylesheet" href="/custom.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
  <nav class="dashboard-nav">
    <div class="nav-brand">
      <img src="/assets/byldur-logo.svg" alt="Byldur">
    </div>
    <div class="nav-links">
      <a href="/dashboard.html">My Projects</a>
      <a href="/templates.html">Templates</a>
      <a href="/subscription.html" class="active">AI Subscription</a>
      <a href="/account.html">Account</a>
      <a href="#" id="logout-link">Logout</a>
    </div>
  </nav>
  
  <main class="subscription-container">
    <header class="subscription-header">
      <h1>AI Website Generation</h1>
      <p>Power your website builder with AI assistance from Claude</p>
    </header>
    
    <div class="subscription-loading" id="loading-indicator">
      <div class="spinner"></div>
      <p>Loading subscription data...</p>
    </div>
    
    <div class="subscription-content" id="subscription-content" style="display: none;">
      <div class="ai-status" id="ai-status-section">
        <!-- AI subscription status will be displayed here -->
      </div>
      
      <div class="subscription-plans">
        <h2>Choose your AI plan</h2>
        <div class="plans-grid">
          <div class="plan-card" id="basic-plan">
            <div class="plan-header">
              <h3>Basic AI</h3>
              <div class="plan-price">$20<span>/month</span></div>
            </div>
            <div class="plan-features">
              <ul>
                <li><i class="fas fa-check"></i> 100 AI requests per month</li>
                <li><i class="fas fa-check"></i> Component generation</li>
                <li><i class="fas fa-check"></i> Code improvement</li>
                <li><i class="fas fa-times"></i> Full template generation</li>
              </ul>
            </div>
            <button class="plan-button" data-plan="basic">Subscribe</button>
          </div>
          
          <div class="plan-card featured" id="pro-plan">
            <div class="plan-tag">Popular</div>
            <div class="plan-header">
              <h3>Pro AI</h3>
              <div class="plan-price">$50<span>/month</span></div>
            </div>
            <div class="plan-features">
              <ul>
                <li><i class="fas fa-check"></i> 500 AI requests per month</li>
                <li><i class="fas fa-check"></i> Component generation</li>
                <li><i class="fas fa-check"></i> Code improvement</li>
                <li><i class="fas fa-check"></i> Full template generation</li>
                <li><i class="fas fa-check"></i> Priority support</li>
              </ul>
            </div>
            <button class="plan-button" data-plan="pro">Subscribe</button>
          </div>
        </div>
      </div>
      
      <div class="credits-section">
        <h2>Need more AI credits?</h2>
        <p>Purchase additional AI credits to use when you exceed your monthly limit.</p>
        
        <div class="credits-options">
          <div class="credit-option">
            <h3>10 Credits</h3>
            <p class="price">$5</p>
            <button class="credit-button" data-amount="10">Purchase</button>
          </div>
          
          <div class="credit-option">
            <h3>50 Credits</h3>
            <p class="price">$20</p>
            <p class="savings">Save 20%</p>
            <button class="credit-button" data-amount="50">Purchase</button>
          </div>
          
          <div class="credit-option">
            <h3>100 Credits</h3>
            <p class="price">$35</p>
            <p class="savings">Save 30%</p>
            <button class="credit-button" data-amount="100">Purchase</button>
          </div>
        </div>
      </div>
      
      <div class="subscription-history">
        <h2>Subscription History</h2>
        <div id="history-table-container">
          <table class="history-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Status</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody id="subscription-history-body">
              <!-- Subscription history will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Payment modal -->
  <div id="payment-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2 id="payment-modal-title">Complete Your Subscription</h2>
      <div id="payment-form-container">
        <form id="payment-form">
          <div id="card-element">
            <!-- Stripe card element will be inserted here -->
          </div>
          <div id="card-errors" class="payment-error"></div>
          <button type="submit" id="submit-payment" class="payment-button">
            <span id="button-text">Subscribe Now</span>
            <div class="spinner hidden" id="payment-spinner"></div>
          </button>
        </form>
      </div>
    </div>
  </div>
  
  <script>
    let stripe;
    let elements;
    let card;
    let currentUser;
    
    // Initialize page
    async function initPage() {
      try {
        // Check authentication
        const authResponse = await fetch('/api/auth/me', {
          credentials: 'include'
        });
        
        if (!authResponse.ok) {
          // Not authenticated, redirect to login
          window.location.href = '/login.html';
          return;
        }
        
        const authData = await authResponse.json();
        currentUser = authData.user;
        
        // Get AI usage data
        const usageResponse = await fetch('/api/ai/usage', {
          credentials: 'include'
        });
        
        if (usageResponse.ok) {
          const usageData = await usageResponse.json();
          updateAIStatus(usageData);
        }
        
        // Get subscription history
        const subscriptionsResponse = await fetch('/api/subscriptions', {
          credentials: 'include'
        });
        
        if (subscriptionsResponse.ok) {
          const subscriptionsData = await subscriptionsResponse.json();
          updateSubscriptionHistory(subscriptionsData.subscriptions);
        }
        
        // Get credit purchases history
        const creditsResponse = await fetch('/api/subscriptions/credits', {
          credentials: 'include'
        });
        
        if (creditsResponse.ok) {
          const creditsData = await creditsResponse.json();
          updateCreditsHistory(creditsData.credits);
        }
        
        // Initialize Stripe
        stripe = Stripe('pk_test_example'); // Replace with your actual publishable key
        
        // Show content
        document.getElementById('loading-indicator').style.display = 'none';
        document.getElementById('subscription-content').style.display = 'block';
        
        // Add event listeners
        setupEventListeners();
      } catch (error) {
        console.error('Error initializing page:', error);
        document.getElementById('loading-indicator').textContent = 'An error occurred. Please try refreshing the page.';
      }
    }
    
    // Update AI status display
    function updateAIStatus(data) {
      const statusSection = document.getElementById('ai-status-section');
      const { subscription, aiUsage } = data;
      
      let statusHtml = '';
      
      if (subscription.status === 'active' && subscription.type !== 'free') {
        // Active subscription
        statusHtml = `
          <div class="status-active">
            <h2><i class="fas fa-check-circle"></i> Active AI Subscription</h2>
            <p>Your ${subscription.type} plan is active until ${new Date(subscription.endDate).toLocaleDateString()}.</p>
            <div class="usage-info">
              <div class="usage-meter">
                <div class="usage-bar" style="width: ${Math.min(100, (aiUsage.requestsThisMonth / (subscription.type === 'basic' ? 100 : 500)) * 100)}%"></div>
              </div>
              <p>${aiUsage.requestsThisMonth} of ${subscription.type === 'basic' ? 100 : 500} requests used this month</p>
            </div>
            ${aiUsage.credits > 0 ? `<p>You also have ${aiUsage.credits} additional AI credits.</p>` : ''}
            <button id="cancel-subscription" class="secondary-button">Cancel Subscription</button>
          </div>
        `;
        
        // Update plan buttons
        if (subscription.type === 'basic') {
          document.querySelector('#basic-plan button').textContent = 'Current Plan';
          document.querySelector('#basic-plan button').disabled = true;
          document.querySelector('#pro-plan button').textContent = 'Upgrade';
        } else if (subscription.type === 'pro') {
          document.querySelector('#pro-plan button').textContent = 'Current Plan';
          document.querySelector('#pro-plan button').disabled = true;
        }
      } else if (subscription.status === 'canceled') {
        // Canceled subscription
        statusHtml = `
          <div class="status-canceled">
            <h2><i class="fas fa-exclamation-circle"></i> Subscription Ending</h2>
            <p>Your ${subscription.type} subscription will end on ${new Date(subscription.endDate).toLocaleDateString()}.</p>
            <div class="usage-info">
              <div class="usage-meter">
                <div class="usage-bar" style="width: ${Math.min(100, (aiUsage.requestsThisMonth / (subscription.type === 'basic' ? 100 : 500)) * 100)}%"></div>
              </div>
              <p>${aiUsage.requestsThisMonth} of ${subscription.type === 'basic' ? 100 : 500} requests used this month</p>
            </div>
            ${aiUsage.credits > 0 ? `<p>You also have ${aiUsage.credits} additional AI credits.</p>` : ''}
            <button id="reactivate-subscription" class="primary-button">Reactivate Subscription</button>
          </div>
        `;
      } else {
        // No subscription
        statusHtml = `
          <div class="status-none">
            <h2><i class="fas fa-info-circle"></i> No Active AI Subscription</h2>
            <p>Subscribe to an AI plan to enhance your website building with Claude AI.</p>
            ${aiUsage.credits > 0 ? `<p>You have ${aiUsage.credits} AI credits available.</p>` : ''}
          </div>
        `;
      }
      
      statusSection.innerHTML = statusHtml;
    }
    
    // Update subscription history table
    function updateSubscriptionHistory(subscriptions) {
      const historyTable = document.getElementById('subscription-history-body');
      
      if (!subscriptions || subscriptions.length === 0) {
        historyTable.innerHTML = `
          <tr>
            <td colspan="4" class="no-data">No subscription history</td>
          </tr>
        `;
        return;
      }
      
      let historyHtml = '';
      subscriptions.forEach(sub => {
        historyHtml += `
          <tr>
            <td>${new Date(sub.startDate).toLocaleDateString()}</td>
            <td>${sub.planType} Subscription</td>
            <td><span class="status-badge ${sub.status}">${sub.status}</span></td>
            <td>$${sub.planType === 'basic' ? '20' : '50'}</td>
          </tr>
        `;
      });
      
      historyTable.innerHTML = historyHtml;
    }
    
    // Update credits purchase history
    function updateCreditsHistory(credits) {
      const historyTable = document.getElementById('subscription-history-body');
      
      if (!credits || credits.length === 0) {
        return;
      }
      
      let historyHtml = historyTable.innerHTML;
      credits.forEach(credit => {
        historyHtml += `
          <tr>
            <td>${new Date(credit.createdAt).toLocaleDateString()}</td>
            <td>${credit.amount} AI Credits</td>
            <td><span class="status-badge ${credit.status}">${credit.status}</span></td>
            <td>$${(credit.priceInCents / 100).toFixed(2)}</td>
          </tr>
        `;
      });
      
      historyTable.innerHTML = historyHtml;
    }
    
    // Set up event listeners
    function setupEventListeners() {
      // Plan subscription buttons
      document.querySelectorAll('.plan-button').forEach(button => {
        if (!button.disabled) {
          button.addEventListener('click', handlePlanSubscription);
        }
      });
      
      // Credit purchase buttons
      document.querySelectorAll('.credit-button').forEach(button => {
        button.addEventListener('click', handleCreditPurchase);
      });
      
      // Cancel subscription button
      const cancelBtn = document.getElementById('cancel-subscription');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', handleCancelSubscription);
      }
      
      // Reactivate subscription button
      const reactivateBtn = document.getElementById('reactivate-subscription');
      if (reactivateBtn) {
        reactivateBtn.addEventListener('click', handleReactivateSubscription);
      }
      
      // Modal close button
      document.querySelector('.close-modal').addEventListener('click', () => {
        document.getElementById('payment-modal').style.display = 'none';
      });
      
      // Logout
      document.getElementById('logout-link').addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          await fetch('/api/auth/logout', {
            method: 'POST',
            credentials: 'include'
          });
          window.location.href = '/login.html';
        } catch (error) {
          console.error('Logout error:', error);
        }
      });
    }
    
    // Handle plan subscription
    async function handlePlanSubscription(e) {
      const planType = e.target.dataset.plan;
      
      try {
        const response = await fetch('/api/subscriptions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ planType }),
          credentials: 'include'
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // Show payment form
          openPaymentModal(`Complete Your ${planType === 'basic' ? 'Basic' : 'Pro'} Subscription`, data.clientSecret);
        } else {
          alert(data.error || 'Failed to create subscription');
        }
      } catch (error) {
        console.error('Subscription error:', error);
        alert('A network error occurred. Please try again.');
      }
    }
    
    // Handle credit purchase
    async function handleCreditPurchase(e) {
      const amount = parseInt(e.target.dataset.amount, 10);
      
      try {
        const response = await fetch('/api/subscriptions/purchase-credits', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount }),
          credentials: 'include'
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // Redirect to Stripe checkout
          window.location.href = data.checkoutUrl;
        } else {
          alert(data.error || 'Failed to create credit purchase');
        }
      } catch (error) {
        console.error('Credit purchase error:', error);
        alert('A network error occurred. Please try again.');
      }
    }
    
    // Handle subscription cancellation
    async function handleCancelSubscription() {
      if (!confirm('Are you sure you want to cancel your subscription? You will still have access until the end of your billing period.')) {
        return;
      }
      
      try {
        const subscriptionsResponse = await fetch('/api/subscriptions', {
          credentials: 'include'
        });
        
        if (!subscriptionsResponse.ok) {
          throw new Error('Failed to fetch subscriptions');
        }
        
        const subscriptionsData = await subscriptionsResponse.json();
        const activeSubscription = subscriptionsData.subscriptions.find(s => s.status === 'active');
        
        if (!activeSubscription) {
          alert('No active subscription found');
          return;
        }
        
        const response = await fetch('/api/subscriptions/cancel', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subscriptionId: activeSubscription._id }),
          credentials: 'include'
        });
        
        const data = await response.json();
        
        if (response.ok) {
          alert('Your subscription has been canceled. You will have access until the end of your billing period.');
          window.location.reload();
        } else {
          alert(data.error || 'Failed to cancel subscription');
        }
      } catch (error) {
        console.error('Cancel subscription error:', error);
        alert('A network error occurred. Please try again.');
      }
    }
    
    // Handle subscription reactivation
    function handleReactivateSubscription() {
      // Just show the plan options again
      alert('Please select a subscription plan to reactivate your AI access.');
      document.querySelector('.subscription-plans').scrollIntoView({ behavior: 'smooth' });
    }
    
    // Open payment modal
    function openPaymentModal(title, clientSecret) {
      document.getElementById('payment-modal-title').textContent = title;
      
      // Create card element if it doesn't exist
      if (!card) {
        elements = stripe.elements();
        card = elements.create('card');
        card.mount('#card-element');
        
        // Add event listeners for card element
        card.addEventListener('change', event => {
          const displayError = document.getElementById('card-errors');
          if (event.error) {
            displayError.textContent = event.error.message;
          } else {
            displayError.textContent = '';
          }
        });
        
        // Add submit event listener for payment form
        document.getElementById('payment-form').addEventListener('submit', async event => {
          event.preventDefault();
          
          // Disable submit button and show loading
          const submitButton = document.getElementById('submit-payment');
          submitButton.disabled = true;
          document.getElementById('button-text').style.display = 'none';
          document.getElementById('payment-spinner').classList.remove('hidden');
          
          try {
            // Confirm payment
            const result = await stripe.confirmCardPayment(clientSecret, {
              payment_method: {
                card: card,
                billing_details: {
                  email: currentUser.email
                }
              }
            });
            
            if (result.error) {
              // Show error message
              document.getElementById('card-errors').textContent = result.error.message;
            } else if (result.paymentIntent.status === 'succeeded') {
              // Payment successful, reload page
              alert('Payment successful! Your subscription is now active.');
              window.location.reload();
            }
          } catch (error) {
            console.error('Payment error:', error);
            document.getElementById('card-errors').textContent = 'An error occurred during payment. Please try again.';
          }
          
          // Re-enable button
          submitButton.disabled = false;
          document.getElementById('button-text').style.display = 'block';
          document.getElementById('payment-spinner').classList.add('hidden');
        });
      }
      
      // Show modal
      document.getElementById('payment-modal').style.display = 'block';
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html>